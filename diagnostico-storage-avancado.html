<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico Avan√ßado - Storage RLS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .content {
            padding: 40px;
        }
        
        .error-display {
            background: #fff5f5;
            border: 2px solid #e53e3e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .error-display h3 {
            color: #e53e3e;
            margin-bottom: 15px;
        }
        
        .error-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            font-size: 0.9em;
            overflow-x: auto;
        }
        
        .diagnostic-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }
        
        .diagnostic-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .status-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .status-value {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-ok {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .log-area {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #333;
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .action-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }
        
        .action-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .action-card p {
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .hidden {
            display: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagn√≥stico Avan√ßado</h1>
            <p>An√°lise completa do erro StorageApiError: new row violates row-level security policy</p>
        </div>
        
        <div class="content">
            <div class="error-display">
                <h3>‚ùå Erro Atual Detectado</h3>
                <div class="error-code">
POST https://migivkdupsydyoyoxgzv.supabase.co/storage/v1/object/produtos-images/1754775200958-Captura%20de%20tela%202025-07-01%20191935.png 400 (Bad Request)

Erro no upload da imagem: StorageApiError: new row violates row-level security policy
                </div>
                <p><strong>An√°lise:</strong> O Storage est√° funcionando (URL acess√≠vel), mas as pol√≠ticas RLS est√£o bloqueando o upload.</p>
            </div>
            
            <div class="error-display" style="background: #fff3cd; border: 2px solid #ffc107;">
                <h3>‚ö†Ô∏è Erro de Privil√©gios Detectado</h3>
                <div class="error-code">
ERROR: 42501: must be owner of table objects
                </div>
                <p><strong>Causa:</strong> Voc√™ n√£o tem privil√©gios de administrador no Supabase</p>
                <p><strong>Solu√ß√µes:</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>üîí Use o "Script Sem Privil√©gios" (diagn√≥stico b√°sico)</li>
                    <li>üéÆ Ative o "Modo Demo Completo" (funciona offline)</li>
                    <li>üëë Pe√ßa ao administrador para executar o script completo</li>
                    <li>üÜï Crie um novo projeto Supabase (voc√™ ser√° o admin)</li>
                </ul>
            </div>
            
            <div class="diagnostic-section">
                <h3>üìä Status do Sistema</h3>
                <div id="systemStatus">
                    <div class="status-item">
                        <span class="status-label">Conex√£o Supabase</span>
                        <span class="status-value status-info" id="connectionStatus">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Storage Habilitado</span>
                        <span class="status-value status-info" id="storageStatus">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Bucket produtos-images</span>
                        <span class="status-value status-info" id="bucketStatus">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Pol√≠ticas RLS</span>
                        <span class="status-value status-info" id="rlsStatus">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Modo Demo</span>
                        <span class="status-value status-info" id="demoStatus">Verificando...</span>
                    </div>
                </div>
            </div>
            
            <div class="actions-grid">
                <div class="action-card">
                    <h4>üîß Corre√ß√£o Autom√°tica</h4>
                    <p>Executa corre√ß√µes autom√°ticas no lado cliente quando poss√≠vel.</p>
                    <button class="btn btn-primary" onclick="autoFix()">Executar Corre√ß√£o</button>
                </div>
                
                <div class="action-card">
                    <h4>üìã Script SQL</h4>
                    <p>Gera script SQL personalizado baseado no diagn√≥stico.</p>
                    <button class="btn btn-success" onclick="generateSQL()">Gerar Script</button>
                </div>
                
                <div class="action-card">
                    <h4>üîí Script Sem Privil√©gios</h4>
                    <p>Script especial para usu√°rios sem privil√©gios administrativos.</p>
                    <button class="btn btn-warning" onclick="openNoPrivilegesScript()">Script Sem Privil√©gios</button>
                </div>
                
                <div class="action-card">
                    <h4>üéÆ Modo Demo Completo</h4>
                    <p>Ativa modo demo completo com funcionalidades offline.</p>
                    <button class="btn btn-warning" onclick="enableFullDemoMode()">Modo Demo Completo</button>
                </div>
                
                <div class="action-card">
                    <h4>üß™ Teste Upload</h4>
                    <p>Testa o upload de uma imagem de exemplo.</p>
                    <button class="btn btn-danger" onclick="testUpload()">Testar Upload</button>
                </div>
            </div>
            
            <div class="diagnostic-section">
                <h3>üìù Log de Diagn√≥stico</h3>
                <div class="log-area" id="logArea">
                    [SISTEMA] Diagn√≥stico iniciado...
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>
            
            <div class="diagnostic-section hidden" id="sqlSection">
                <h3>üìÑ Script SQL Gerado</h3>
                <textarea id="generatedSQL" style="width: 100%; height: 200px; font-family: monospace; padding: 15px; border-radius: 8px; border: 2px solid #ddd;"></textarea>
                <br><br>
                <button class="btn btn-primary" onclick="copySQL()">üìã Copiar Script</button>
                <button class="btn btn-success" onclick="openSupabase()">üöÄ Abrir Supabase</button>
            </div>
        </div>
    </div>
    
    <script src="assets/js/supabase.js"></script>
    <script>
        let diagnosticData = {};
        
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                error: '#ff4444',
                warning: '#ffaa00',
                success: '#00ff88'
            };
            
            logArea.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateStatus(elementId, status, type) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = `status-value status-${type}`;
        }
        
        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }
        
        async function runDiagnostic() {
            log('Iniciando diagn√≥stico completo...', 'info');
            updateProgress(10);
            
            // Verificar conex√£o Supabase
            try {
                if (typeof supabaseClient !== 'undefined') {
                    updateStatus('connectionStatus', '‚úÖ Conectado', 'ok');
                    log('Conex√£o Supabase: OK', 'success');
                    diagnosticData.connection = true;
                } else {
                    updateStatus('connectionStatus', '‚ùå N√£o conectado', 'error');
                    log('Conex√£o Supabase: ERRO - Cliente n√£o inicializado', 'error');
                    diagnosticData.connection = false;
                }
            } catch (error) {
                updateStatus('connectionStatus', '‚ùå Erro', 'error');
                log(`Conex√£o Supabase: ERRO - ${error.message}`, 'error');
                diagnosticData.connection = false;
            }
            updateProgress(30);
            
            // Verificar modo demo
            try {
                if (typeof isDemoMode !== 'undefined' && isDemoMode) {
                    updateStatus('demoStatus', 'üéÆ Ativo', 'warning');
                    log('Modo Demo: ATIVO', 'warning');
                    diagnosticData.demoMode = true;
                } else {
                    updateStatus('demoStatus', 'üî¥ Inativo', 'info');
                    log('Modo Demo: INATIVO (modo real)', 'info');
                    diagnosticData.demoMode = false;
                }
            } catch (error) {
                updateStatus('demoStatus', '‚ùì Desconhecido', 'warning');
                log(`Modo Demo: ERRO - ${error.message}`, 'error');
                diagnosticData.demoMode = null;
            }
            updateProgress(50);
            
            // Verificar Storage (simulado)
            try {
                // Como temos a URL do erro, sabemos que o Storage est√° habilitado
                updateStatus('storageStatus', '‚úÖ Habilitado', 'ok');
                log('Storage: HABILITADO (confirmado pela URL do erro)', 'success');
                diagnosticData.storage = true;
            } catch (error) {
                updateStatus('storageStatus', '‚ùå Erro', 'error');
                log(`Storage: ERRO - ${error.message}`, 'error');
                diagnosticData.storage = false;
            }
            updateProgress(70);
            
            // Verificar bucket
            updateStatus('bucketStatus', '‚ö†Ô∏è Existe mas com RLS', 'warning');
            log('Bucket produtos-images: EXISTE mas pol√≠ticas RLS est√£o bloqueando', 'warning');
            diagnosticData.bucket = 'rls_blocked';
            updateProgress(85);
            
            // Verificar RLS
            updateStatus('rlsStatus', '‚ùå Bloqueando uploads', 'error');
            log('Pol√≠ticas RLS: BLOQUEANDO uploads - Necess√°ria corre√ß√£o', 'error');
            diagnosticData.rls = 'blocking';
            updateProgress(100);
            
            log('Diagn√≥stico conclu√≠do!', 'success');
            log('Recomenda√ß√£o: Execute a corre√ß√£o autom√°tica ou use o script SQL', 'info');
        }
        
        async function autoFix() {
            log('Iniciando corre√ß√£o autom√°tica...', 'info');
            
            if (diagnosticData.demoMode === false) {
                log('Tentando ativar modo demo tempor√°rio...', 'warning');
                try {
                    // Tentar modificar a vari√°vel isDemoMode se existir
                    if (typeof window.isDemoMode !== 'undefined') {
                        window.isDemoMode = true;
                        log('Modo demo ativado temporariamente!', 'success');
                        updateStatus('demoStatus', 'üéÆ Ativo (temp)', 'warning');
                    } else {
                        log('N√£o foi poss√≠vel ativar modo demo automaticamente', 'warning');
                        log('Solu√ß√£o: Edite manualmente assets/js/supabase.js', 'info');
                    }
                } catch (error) {
                    log(`Erro ao ativar modo demo: ${error.message}`, 'error');
                }
            }
            
            log('Corre√ß√£o autom√°tica conclu√≠da!', 'success');
            log('Se o problema persistir, use o script SQL', 'info');
        }
        
        function generateSQL() {
            log('Gerando script SQL personalizado...', 'info');
            
            const sql = `-- SCRIPT PERSONALIZADO BASEADO NO DIAGN√ìSTICO
-- Gerado em: ${new Date().toLocaleString()}
-- URL Supabase: https://migivkdupsydyoyoxgzv.supabase.co

-- 1. VERIFICAR STATUS ATUAL
SELECT 
    current_user as usuario,
    current_database() as banco,
    now() as timestamp;

-- 2. VERIFICAR BUCKET
SELECT * FROM storage.buckets WHERE id = 'produtos-images';

-- 3. LISTAR POL√çTICAS ATUAIS
SELECT policyname, cmd FROM pg_policies 
WHERE schemaname = 'storage' AND tablename = 'objects';

-- 4. REMOVER POL√çTICAS CONFLITANTES
DROP POLICY IF EXISTS "produtos_select_public" ON storage.objects;
DROP POLICY IF EXISTS "produtos_insert_public" ON storage.objects;
DROP POLICY IF EXISTS "produtos_update_public" ON storage.objects;
DROP POLICY IF EXISTS "produtos_delete_public" ON storage.objects;

-- 5. RECRIAR BUCKET (se necess√°rio)
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'produtos-images',
    'produtos-images',
    true,
    52428800,
    ARRAY['image/jpeg', 'image/png', 'image/webp', 'image/gif']
)
ON CONFLICT (id) DO UPDATE SET
    public = EXCLUDED.public,
    file_size_limit = EXCLUDED.file_size_limit,
    allowed_mime_types = EXCLUDED.allowed_mime_types;

-- 6. CRIAR POL√çTICAS ULTRA-PERMISSIVAS
CREATE POLICY "produtos_all_access_select"
ON storage.objects FOR SELECT
USING (bucket_id = 'produtos-images');

CREATE POLICY "produtos_all_access_insert"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'produtos-images');

CREATE POLICY "produtos_all_access_update"
ON storage.objects FOR UPDATE
USING (bucket_id = 'produtos-images')
WITH CHECK (bucket_id = 'produtos-images');

CREATE POLICY "produtos_all_access_delete"
ON storage.objects FOR DELETE
USING (bucket_id = 'produtos-images');

-- 7. HABILITAR RLS
ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

-- 8. VERIFICA√á√ÉO FINAL
SELECT 
    'Configura√ß√£o conclu√≠da!' as status,
    COUNT(*) as politicas_criadas
FROM pg_policies 
WHERE schemaname = 'storage' 
AND tablename = 'objects'
AND policyname LIKE 'produtos_all_access_%';

-- 9. TESTE DE CONECTIVIDADE
SELECT 
    id,
    name,
    public,
    'Bucket configurado e pronto!' as resultado
FROM storage.buckets 
WHERE id = 'produtos-images';`;
            
            document.getElementById('generatedSQL').value = sql;
            document.getElementById('sqlSection').classList.remove('hidden');
            log('Script SQL gerado com sucesso!', 'success');
        }
        
        function copySQL() {
            const textarea = document.getElementById('generatedSQL');
            textarea.select();
            document.execCommand('copy');
            log('Script SQL copiado para a √°rea de transfer√™ncia!', 'success');
            alert('‚úÖ Script copiado!\n\nAgora:\n1. Abra o Supabase Dashboard\n2. V√° para SQL Editor\n3. Cole e execute o script');
        }
        
        function openSupabase() {
            window.open('https://app.supabase.com', '_blank');
            log('Supabase Dashboard aberto em nova aba', 'info');
        }
        
        function openNoPrivilegesScript() {
            log('üîí Abrindo script para usu√°rios sem privil√©gios...', 'info');
            
            // Abrir o script em nova aba
            window.open('fix-sem-privilegios.sql', '_blank');
            
            alert(`üîí SCRIPT SEM PRIVIL√âGIOS

‚úÖ Aberto: fix-sem-privilegios.sql

üìã COMO USAR:
1. Copie todo o conte√∫do do script
2. Cole no SQL Editor do Supabase
3. Execute linha por linha
4. Siga as recomenda√ß√µes do diagn√≥stico

üí° Este script funciona mesmo sem privil√©gios de admin!

üéØ SE FALHAR:
‚Üí Use o "Modo Demo Completo"
‚Üí Pe√ßa ajuda ao administrador
‚Üí Verifique seu plano Supabase`);
            
            log('üìÑ Script sem privil√©gios aberto', 'success');
        }
        
        function enableFullDemoMode() {
            log('üéÆ Ativando modo demo completo...', 'info');
            
            // Abrir o script de demo
            window.open('ativar-modo-demo-completo.js', '_blank');
            
            alert(`üéÆ MODO DEMO COMPLETO - Instru√ß√µes:

‚úÖ Aberto: ativar-modo-demo-completo.js

üöÄ ATIVA√á√ÉO R√ÅPIDA:
1. Pressione F12 (Console do navegador)
2. Copie TODO o c√≥digo do arquivo aberto
3. Cole no Console
4. Pressione Enter
5. ‚úÖ Modo demo ativado!

üéØ FUNCIONALIDADES:
‚úÖ Upload de imagens (offline)
‚úÖ CRUD completo (localStorage)
‚úÖ Sem erros de RLS
‚úÖ Sem necessidade de Supabase

üí° Perfeito para testes e desenvolvimento!`);
            
            log('üéÆ Modo demo completo configurado', 'success');
        }
        
        function testUpload() {
            log('Redirecionando para teste de upload...', 'info');
            window.location.href = '/admin/';
        }
        
        // Iniciar diagn√≥stico automaticamente
        window.addEventListener('load', function() {
            setTimeout(runDiagnostic, 1000);
        });
    </script>
</body>
</html>